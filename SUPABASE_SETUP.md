# Supabase Backend Setup for HSC Hand Notes

Follow these steps to set up your Supabase project. You can run all of this SQL code at once in the Supabase SQL Editor.

**Important:** This schema will first **DROP** (delete) your existing `notes` table to replace it with a new, structured version. This will remove all your current notes.

## 1. Full SQL Schema

Go to the **SQL Editor** in your Supabase project dashboard and run the following SQL command.

```sql
-- Drop the old 'notes' table if it exists, to apply the new schema.
-- WARNING: This will delete all existing data in the notes table.
DROP TABLE IF EXISTS public.notes;

-- 1. Create the 'subjects' table to store subject names.
CREATE TABLE public.subjects (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name TEXT NOT NULL UNIQUE,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);
COMMENT ON TABLE public.subjects IS 'Stores all the subjects.';

-- 2. Create the 'chapters' table to store chapter names, linked to subjects.
CREATE TABLE public.chapters (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  subject_id BIGINT NOT NULL REFERENCES public.subjects(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  UNIQUE(subject_id, name) -- Ensures chapter names are unique within a subject
);
COMMENT ON TABLE public.chapters IS 'Stores chapters for each subject.';

-- 3. Create the 'notes' table with foreign keys to subjects and chapters.
CREATE TABLE public.notes (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  subject_id BIGINT NOT NULL REFERENCES public.subjects(id) ON DELETE RESTRICT,
  chapter_id BIGINT NOT NULL REFERENCES public.chapters(id) ON DELETE RESTRICT,
  topic_title TEXT NOT NULL,
  content TEXT,
  pdf_url TEXT,
  is_published BOOLEAN DEFAULT TRUE NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);
COMMENT ON TABLE public.notes IS 'Stores all the handwritten study notes.';


-- 4. Enable Row Level Security on all tables.
ALTER TABLE public.subjects ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.chapters ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.notes ENABLE ROW LEVEL SECURITY;

-- 5. Create policies for 'subjects' table.
CREATE POLICY "Public read access for subjects"
ON public.subjects
FOR SELECT
TO anon
USING (true);

CREATE POLICY "Full access for service role on subjects"
ON public.subjects
FOR ALL
TO service_role
USING (true);

-- 6. Create policies for 'chapters' table.
CREATE POLICY "Public read access for chapters"
ON public.chapters
FOR SELECT
TO anon
USING (true);

CREATE POLICY "Full access for service role on chapters"
ON public.chapters
FOR ALL
TO service_role
USING (true);

-- 7. Create policies for 'notes' table.
CREATE POLICY "Public read-only access to published notes"
ON public.notes
FOR SELECT
TO anon
USING (is_published = TRUE);

CREATE POLICY "Full access for service role on notes"
ON public.notes
FOR ALL
TO service_role
USING (true);

```

## 2. Setup Storage for PDF Uploads

This part remains the same. If you've already done this, you don't need to do it again.

```sql
-- 1. Create a storage bucket named 'notes-pdfs' to hold the uploaded PDF files.
-- Make it public so that anyone with the URL can view the file.
INSERT INTO storage.buckets (id, name, public)
VALUES ('notes-pdfs', 'notes-pdfs', TRUE)
ON CONFLICT (id) DO NOTHING;

-- 2. Create a policy that allows the 'service_role' (your admin server) to upload files to the 'notes-pdfs' bucket.
CREATE POLICY "Allow service_role to upload PDFs"
ON storage.objects
FOR INSERT TO service_role
WITH CHECK (bucket_id = 'notes-pdfs');

-- 3. Create a policy that allows the 'service_role' to update existing files.
CREATE POLICY "Allow service_role to update PDFs"
ON storage.objects
FOR UPDATE TO service_role
USING (bucket_id = 'notes-pdfs');

-- 4. Create a policy that allows the 'service_role' to delete files.
CREATE POLICY "Allow service_role to delete PDFs"
ON storage.objects
FOR DELETE TO service_role
USING (bucket_id = 'notes-pdfs');

-- 5. (IMPORTANT) Allow public, anonymous access to view/read files in the bucket.
-- This is required so the PDF viewer in the browser can fetch and display the file.
CREATE POLICY "Public read access for PDFs"
ON storage.objects
FOR SELECT
TO anon
USING (bucket_id = 'notes-pdfs');
```

## 3. Get Project Credentials

You'll need your Supabase Project URL, the `anon` (public) key, and the `service_role` key.

1.  Go to your project's **Settings**.
2.  Click on the **API** tab.
3.  Under **Project API Keys**, you will find your `anon` key (labeled as `public`) and your `service_role` key.
4.  You will also find your Project **URL** there.

Create a `.env.local` file in the root of your project and add these credentials. **Keep your service_role key secret!**

```
NEXT_PUBLIC_SUPABASE_URL=YOUR_PROJECT_URL
NEXT_PUBLIC_SUPABASE_ANON_KEY=YOUR_ANON_KEY
SUPABASE_SERVICE_ROLE_KEY=YOUR_SERVICE_ROLE_KEY
```

## 4. (Optional) Add Example Data

To add some example notes to your database, run the following SQL in the **SQL Editor**:

```sql
-- Insert subjects
INSERT INTO public.subjects (name) VALUES ('Physics'), ('Chemistry'), ('Math') ON CONFLICT (name) DO NOTHING;

-- Get subject IDs
DO $$
DECLARE
    physics_id BIGINT;
    chemistry_id BIGINT;
    math_id BIGINT;
BEGIN
    SELECT id INTO physics_id FROM public.subjects WHERE name = 'Physics';
    SELECT id INTO chemistry_id FROM public.subjects WHERE name = 'Chemistry';
    SELECT id INTO math_id FROM public.subjects WHERE name = 'Math';

    -- Insert chapters
    INSERT INTO public.chapters (subject_id, name) VALUES
    (physics_id, 'Chapter 1: Physical World and Measurement'),
    (physics_id, 'Chapter 2: Kinematics'),
    (chemistry_id, 'Chapter 1: Some Basic Concepts of Chemistry'),
    (chemistry_id, 'Chapter 2: Structure of Atom'),
    (math_id, 'Chapter 1: Sets')
    ON CONFLICT (subject_id, name) DO NOTHING;

END $$;

-- Insert notes
DO $$
DECLARE
    physics_id BIGINT;
    chem_id BIGINT;
    math_id BIGINT;
    ch1_phys_id BIGINT;
    ch2_phys_id BIGINT;
    ch1_chem_id BIGINT;
    ch2_chem_id BIGINT;
    ch1_math_id BIGINT;
BEGIN
    -- Get subject IDs
    SELECT id INTO physics_id FROM public.subjects WHERE name = 'Physics';
    SELECT id INTO chem_id FROM public.subjects WHERE name = 'Chemistry';
    SELECT id INTO math_id FROM public.subjects WHERE name = 'Math';

    -- Get chapter IDs
    SELECT id INTO ch1_phys_id FROM public.chapters WHERE subject_id = physics_id AND name = 'Chapter 1: Physical World and Measurement';
    SELECT id INTO ch2_phys_id FROM public.chapters WHERE subject_id = physics_id AND name = 'Chapter 2: Kinematics';
    SELECT id INTO ch1_chem_id FROM public.chapters WHERE subject_id = chem_id AND name = 'Chapter 1: Some Basic Concepts of Chemistry';
    SELECT id INTO ch2_chem_id FROM public.chapters WHERE subject_id = chem_id AND name = 'Chapter 2: Structure of Atom';
    SELECT id INTO ch1_math_id FROM public.chapters WHERE subject_id = math_id AND name = 'Chapter 1: Sets';

    -- Insert notes
    INSERT INTO public.notes (subject_id, chapter_id, topic_title, content, pdf_url, is_published)
    VALUES
    (physics_id, ch1_phys_id, 'Units and Measurements', 'This is a note about the fundamental and derived units in physics.', 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', TRUE),
    (physics_id, ch1_phys_id, 'Errors in Measurement', 'Discussing systematic and random errors.', 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', TRUE),
    (physics_id, ch2_phys_id, 'Motion in a Straight Line', 'Key concepts of kinematics.', NULL, TRUE),
    (chem_id, ch1_chem_id, 'Mole Concept', 'The mole is the unit of amount in chemistry.', NULL, TRUE),
    (chem_id, ch1_chem_id, 'Stoichiometry', 'Calculations based on chemical equations.', NULL, FALSE),
    (chem_id, ch2_chem_id, 'Bohrs Model', 'Explaining the model of an atom.', NULL, TRUE),
    (math_id, ch1_math_id, 'Introduction to Sets', 'A set is a collection of distinct objects.', NULL, TRUE);

END $$;
```