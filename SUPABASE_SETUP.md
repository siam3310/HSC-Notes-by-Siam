# Supabase Backend Setup for HSC Hand Notes

Follow these steps to set up your Supabase project. You can run all of this SQL code at once in the Supabase SQL Editor.

**Important:** This schema documentation outlines the final structure. For migrating existing data, please use the non-destructive scripts provided in the later sections.

## 1. Full SQL Schema (For new projects)

If you are starting a new project, you can go to the **SQL Editor** in your Supabase project dashboard and run the following SQL command.

```sql
-- Drop old tables if they exist to apply the new schema.
-- WARNING: This will delete all existing data in these tables.
DROP TABLE IF EXISTS public.note_images;
DROP TABLE IF EXISTS public.notes;
DROP TABLE IF EXISTS public.chapters;
DROP TABLE IF EXISTS public.subjects;

-- 1. Create the 'subjects' table to store subject names.
CREATE TABLE public.subjects (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name TEXT NOT NULL UNIQUE,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);
COMMENT ON TABLE public.subjects IS 'Stores all the subjects.';

-- 2. Create the 'chapters' table to store chapter names, linked to subjects.
CREATE TABLE public.chapters (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  subject_id BIGINT NOT NULL REFERENCES public.subjects(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  UNIQUE(subject_id, name) -- Ensures chapter names are unique within a subject
);
COMMENT ON TABLE public.chapters IS 'Stores chapters for each subject.';

-- 3. Create the 'notes' table with both pdf_url and content being optional.
CREATE TABLE public.notes (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  subject_id BIGINT NOT NULL REFERENCES public.subjects(id) ON DELETE RESTRICT,
  chapter_id BIGINT REFERENCES public.chapters(id) ON DELETE RESTRICT,
  topic_title TEXT NOT NULL,
  content TEXT,
  pdf_url TEXT, -- For single PDF uploads
  is_published BOOLEAN DEFAULT TRUE NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);
COMMENT ON TABLE public.notes IS 'Stores all the handwritten study notes.';

-- 4. Create the 'note_images' table for the one-to-many relationship with notes.
CREATE TABLE public.note_images (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    note_id BIGINT NOT NULL REFERENCES public.notes(id) ON DELETE CASCADE,
    image_url TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);
COMMENT ON TABLE public.note_images IS 'Stores image URLs for each note.';

-- 5. Enable Row Level Security on all tables.
ALTER TABLE public.subjects ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.chapters ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.notes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.note_images ENABLE ROW LEVEL SECURITY;

-- 6. Create policies for 'subjects' table.
CREATE POLICY "Public read access for subjects"
ON public.subjects FOR SELECT TO anon, authenticated USING (true);
CREATE POLICY "Full access for service role on subjects"
ON public.subjects FOR ALL TO service_role USING (true);

-- 7. Create policies for 'chapters' table.
CREATE POLICY "Public read access for chapters"
ON public.chapters FOR SELECT TO anon, authenticated USING (true);
CREATE POLICY "Full access for service role on chapters"
ON public.chapters FOR ALL TO service_role USING (true);

-- 8. Create policies for 'notes' table.
CREATE POLICY "Public read-only access to published notes"
ON public.notes FOR SELECT TO anon, authenticated USING (is_published = TRUE);
CREATE POLICY "Full access for service role on notes"
ON public.notes FOR ALL TO service_role USING (true);

-- 9. Create policies for 'note_images' table.
-- Allow public read access to images of published notes.
CREATE POLICY "Public read access for note images"
ON public.note_images FOR SELECT TO anon, authenticated USING (
  (SELECT is_published FROM public.notes WHERE id = note_id)
);
CREATE POLICY "Full access for service role on note_images"
ON public.note_images FOR ALL TO service_role USING (true);
```

## 2. Setup Storage for PDF/Image Uploads

This part remains the same. If you've already done this, you don't need to do it again.

```sql
-- 1. Create a storage bucket named 'notes-pdfs' to hold the uploaded files.
-- Make it public so that anyone with the URL can view the file.
INSERT INTO storage.buckets (id, name, public)
VALUES ('notes-pdfs', 'notes-pdfs', TRUE)
ON CONFLICT (id) DO NOTHING;

-- 2. Create policies for the 'notes-pdfs' bucket.
CREATE POLICY "Allow service_role to upload files"
ON storage.objects FOR INSERT TO service_role WITH CHECK (bucket_id = 'notes-pdfs');

CREATE POLICY "Allow service_role to update files"
ON storage.objects FOR UPDATE TO service_role USING (bucket_id = 'notes-pdfs');

CREATE POLICY "Allow service_role to delete files"
ON storage.objects FOR DELETE TO service_role USING (bucket_id = 'notes-pdfs');

CREATE POLICY "Public read access for files"
ON storage.objects FOR SELECT TO anon, authenticated USING (bucket_id = 'notes-pdfs');
```

## 3. Get Project Credentials

You'll need your Supabase Project URL, the `anon` (public) key, and the `service_role` key.

1.  Go to your project's **Settings**.
2.  Click on the **API** tab.
3.  Under **Project API Keys**, you will find your `anon` key (labeled as `public`) and your `service_role` key.
4.  You will also find your Project **URL** there.

Create a `.env.local` file in the root of your project and add these credentials. **Keep your service_role key secret!**

```
NEXT_PUBLIC_SUPABASE_URL=YOUR_PROJECT_URL
NEXT_PUBLIC_SUPABASE_ANON_KEY=YOUR_ANON_KEY
SUPABASE_SERVICE_ROLE_KEY=YOUR_SERVICE_ROLE_KEY
```

## 4. (Optional) Add Example Data

To add some example notes to your database, run the following SQL in the **SQL Editor**:

```sql
-- Insert the new list of subjects provided by the user.
INSERT INTO public.subjects (name) VALUES
('বাংলা ১ম পত্র'),
('বাংলা ২য় পত্র'),
('English 1st Paper'),
('English 2nd Paper'),
('তথ্য ও যোগাযোগ প্রযুক্তি'),
('পৌরনীতি ও সুশাসন ১ম পত্র'),
('পৌরনীতি ও সুশাসন ২য় পত্র'),
('সমাজকর্ম ১ম পত্র'),
('সমাজকর্ম ২য় পত্র'),
('ইসলামের ইতিহাস ও সংস্কৃতি ১ম পত্র'),
('ইসলামের ইতিহাস ও সংস্কৃতি ২য় পত্র'),
('ভূগোল ১ম পত্র'),
('ভূগোল ২য় পত্র')
ON CONFLICT (name) DO NOTHING;
```

## 5. Non-Destructive Schema Update for Multiple Images & PDF

If you have existing data and want to update your schema to support both a PDF and multiple images without losing any data, **run the following safe script**. This is the recommended method.

```sql
-- Step 1: Add the 'pdf_url' column back to the 'notes' table if it doesn't exist.
-- This ensures backward compatibility for older notes that had a PDF.
ALTER TABLE public.notes
ADD COLUMN IF NOT EXISTS pdf_url TEXT;

-- Step 2: Create the new 'note_images' table to store multiple images per note.
-- This will only be created if it doesn't already exist.
CREATE TABLE IF NOT EXISTS public.note_images (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    note_id BIGINT NOT NULL REFERENCES public.notes(id) ON DELETE CASCADE,
    image_url TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);
COMMENT ON TABLE public.note_images IS 'Stores image URLs for each note.';

-- Step 3: Ensure 'chapter_id' is optional in the 'notes' table.
ALTER TABLE public.notes
ALTER COLUMN chapter_id DROP NOT NULL;

-- Step 4: Create/Recreate security policies for the 'note_images' table for safety.
DROP POLICY IF EXISTS "Public read access for note images" ON public.note_images;
CREATE POLICY "Public read access for note images"
ON public.note_images FOR SELECT TO anon, authenticated USING (
  (SELECT is_published FROM public.notes WHERE id = note_id)
);

DROP POLICY IF EXISTS "Full access for service role on note_images" ON public.note_images;
CREATE POLICY "Full access for service role on note_images"
ON public.note_images FOR ALL TO service_role USING (true);

-- Step 5: Enable Row Level Security on the new table if it's not already enabled.
ALTER TABLE public.note_images ENABLE ROW LEVEL SECURITY;
```
