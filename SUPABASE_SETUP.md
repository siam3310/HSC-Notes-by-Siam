# Supabase Backend Setup for HSC Hand Notes

Follow these steps to set up your Supabase project. You can run all of this SQL code at once in the Supabase SQL Editor.

## 1. Full SQL Schema

Go to the **SQL Editor** in your Supabase project dashboard and run the following SQL command. This will create the `notes` table, enable Row Level Security, and set up the necessary access policies.

```sql
-- 1. Create the 'notes' table to store all study materials.
CREATE TABLE public.notes (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  subject TEXT NOT NULL,
  chapter_name TEXT NOT NULL,
  topic_title TEXT NOT NULL,
  content_html TEXT,
  pdf_url TEXT,
  is_published BOOLEAN DEFAULT TRUE NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

COMMENT ON TABLE public.notes IS 'Stores all the handwritten study notes.';

-- 2. Enable Row Level Security on the 'notes' table to secure data by default.
ALTER TABLE public.notes ENABLE ROW LEVEL SECURITY;

-- 3. Create a policy to allow public (anonymous) read-only access to published notes.
-- This ensures that users can only see notes that are marked as 'is_published'.
CREATE POLICY "Public read access to published notes"
ON public.notes
FOR SELECT
TO anon
USING (is_published = TRUE);

-- 4. Create a policy to grant full access (SELECT, INSERT, UPDATE, DELETE) to authenticated users with the 'service_role'.
-- This is necessary for the admin panel to manage all notes, including drafts.
-- NOTE: The web client will NOT use this policy. We will use a separate admin client on the server for these operations.
CREATE POLICY "Full access for service role"
ON public.notes
FOR ALL
TO service_role
USING (true);
```

## 2. Setup Storage for PDF Uploads

Run the following SQL in your Supabase SQL Editor to set up the storage bucket and policies for direct PDF uploads.

```sql
-- 1. Create a storage bucket named 'notes-pdfs' to hold the uploaded PDF files.
-- Make it public so that anyone with the URL can view the file.
INSERT INTO storage.buckets (id, name, public)
VALUES ('notes-pdfs', 'notes-pdfs', TRUE)
ON CONFLICT (id) DO NOTHING;

-- 2. Create a policy that allows the 'service_role' (your admin server) to upload files to the 'notes-pdfs' bucket.
CREATE POLICY "Allow service_role to upload PDFs"
ON storage.objects
FOR INSERT TO service_role
WITH CHECK (bucket_id = 'notes-pdfs');

-- 3. Create a policy that allows the 'service_role' to update existing files.
CREATE POLICY "Allow service_role to update PDFs"
ON storage.objects
FOR UPDATE TO service_role
USING (bucket_id = 'notes-pdfs');

-- 4. Create a policy that allows the 'service_role' to delete files.
CREATE POLICY "Allow service_role to delete PDFs"
ON storage.objects
FOR DELETE TO service_role
USING (bucket_id = 'notes-pdfs');

-- 5. (IMPORTANT) Allow public, anonymous access to view/read files in the bucket.
-- This is required so the PDF viewer in the browser can fetch and display the file.
CREATE POLICY "Public read access for PDFs"
ON storage.objects
FOR SELECT
TO anon
USING (bucket_id = 'notes-pdfs');
```

## 3. Get Project Credentials

You'll need your Supabase Project URL, the `anon` (public) key, and the `service_role` key.

1.  Go to your project's **Settings**.
2.  Click on the **API** tab.
3.  Under **Project API Keys**, you will find your `anon` key (labeled as `public`) and your `service_role` key.
4.  You will also find your Project **URL** there.

Create a `.env.local` file in the root of your project and add these credentials. **Keep your service_role key secret!**

```
NEXT_PUBLIC_SUPABASE_URL=YOUR_PROJECT_URL
NEXT_PUBLIC_SUPABASE_ANON_KEY=YOUR_ANON_KEY
SUPABASE_SERVICE_ROLE_KEY=YOUR_SERVICE_ROLE_KEY
```

## 4. (Optional) Add Example Data

To add some example notes to your database, run the following SQL in the **SQL Editor**:

```sql
INSERT INTO public.notes (subject, chapter_name, topic_title, content_html, pdf_url, is_published)
VALUES
('Physics', 'Chapter 1: Physical World and Measurement', 'Units and Measurements', '<h1>Introduction to Units</h1><p>This is a note about the fundamental and derived units in physics.</p>', 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', TRUE),
('Physics', 'Chapter 1: Physical World and Measurement', 'Errors in Measurement', '<p>Discussing systematic and random errors.</p>', 'https://drive.google.com/file/d/1Rp7-NdDHeRtdva1uz6q3T7qe0n0bPkNq/view', TRUE),
('Physics', 'Chapter 2: Kinematics', 'Motion in a Straight Line', '<h1>Speed and Velocity</h1><p>Key concepts of kinematics.</p>', NULL, TRUE),
('Chemistry', 'Chapter 1: Some Basic Concepts of Chemistry', 'Mole Concept', '<h1>Avogadros Number</h1><p>The mole is the unit of amount in chemistry.</p>', NULL, TRUE),
('Chemistry', 'Chapter 1: Some Basic Concepts of Chemistry', 'Stoichiometry', '<p>Calculations based on chemical equations.</p>', NULL, FALSE),
('Chemistry', 'Chapter 2: Structure of Atom', 'Bohrs Model', '<h1>Postulates of Bohrs Model</h1><p>Explaining the model of an atom.</p>', NULL, TRUE),
('Math', 'Chapter 1: Sets', 'Introduction to Sets', '<h1>What is a set?</h1><p>A set is a collection of distinct objects.</p>', NULL, TRUE),
('Math', 'Chapter 1: Sets', 'Venn Diagrams', '<p>Visual representation of sets.</p>', NULL, TRUE);
```
