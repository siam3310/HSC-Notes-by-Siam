# Supabase Backend Setup for HSC Hand Notes

Follow these steps to set up your Supabase project. You can run all of this SQL code at once in the Supabase SQL Editor.

**Important:** This schema will first **DROP** (delete) your existing tables to replace them with the new, structured version. This will remove all your current data in those tables.

## 1. Full SQL Schema

Go to the **SQL Editor** in your Supabase project dashboard and run the following SQL command.

```sql
-- Drop old tables if they exist to apply the new schema.
-- WARNING: This will delete all existing data in these tables.
DROP TABLE IF EXISTS public.note_images;
DROP TABLE IF EXISTS public.notes;
DROP TABLE IF EXISTS public.chapters;
DROP TABLE IF EXISTS public.subjects;

-- 1. Create the 'subjects' table to store subject names.
CREATE TABLE public.subjects (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name TEXT NOT NULL UNIQUE,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);
COMMENT ON TABLE public.subjects IS 'Stores all the subjects.';

-- 2. Create the 'chapters' table to store chapter names, linked to subjects.
CREATE TABLE public.chapters (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  subject_id BIGINT NOT NULL REFERENCES public.subjects(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  UNIQUE(subject_id, name) -- Ensures chapter names are unique within a subject
);
COMMENT ON TABLE public.chapters IS 'Stores chapters for each subject.';

-- 3. Create the 'notes' table. Note the pdf_url column is removed.
CREATE TABLE public.notes (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  subject_id BIGINT NOT NULL REFERENCES public.subjects(id) ON DELETE RESTRICT,
  chapter_id BIGINT REFERENCES public.chapters(id) ON DELETE RESTRICT,
  topic_title TEXT NOT NULL,
  content TEXT,
  is_published BOOLEAN DEFAULT TRUE NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);
COMMENT ON TABLE public.notes IS 'Stores all the handwritten study notes.';

-- 4. Create the 'note_images' table for the one-to-many relationship with notes.
CREATE TABLE public.note_images (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    note_id BIGINT NOT NULL REFERENCES public.notes(id) ON DELETE CASCADE,
    image_url TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);
COMMENT ON TABLE public.note_images IS 'Stores image URLs for each note.';

-- 5. Enable Row Level Security on all tables.
ALTER TABLE public.subjects ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.chapters ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.notes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.note_images ENABLE ROW LEVEL SECURITY;

-- 6. Create policies for 'subjects' table.
CREATE POLICY "Public read access for subjects"
ON public.subjects FOR SELECT TO anon USING (true);
CREATE POLICY "Full access for service role on subjects"
ON public.subjects FOR ALL TO service_role USING (true);

-- 7. Create policies for 'chapters' table.
CREATE POLICY "Public read access for chapters"
ON public.chapters FOR SELECT TO anon USING (true);
CREATE POLICY "Full access for service role on chapters"
ON public.chapters FOR ALL TO service_role USING (true);

-- 8. Create policies for 'notes' table.
CREATE POLICY "Public read-only access to published notes"
ON public.notes FOR SELECT TO anon USING (is_published = TRUE);
CREATE POLICY "Full access for service role on notes"
ON public.notes FOR ALL TO service_role USING (true);

-- 9. Create policies for 'note_images' table.
-- Allow public read access to images of published notes.
CREATE POLICY "Public read access for note images"
ON public.note_images FOR SELECT TO anon USING (
  (SELECT is_published FROM public.notes WHERE id = note_id)
);
CREATE POLICY "Full access for service role on note_images"
ON public.note_images FOR ALL TO service_role USING (true);
```

## 2. Setup Storage for PDF/Image Uploads

This part remains the same. If you've already done this, you don't need to do it again. The bucket name is kept as 'notes-pdfs' for simplicity, but it will store images.

```sql
-- 1. Create a storage bucket named 'notes-pdfs' to hold the uploaded files.
-- Make it public so that anyone with the URL can view the file.
INSERT INTO storage.buckets (id, name, public)
VALUES ('notes-pdfs', 'notes-pdfs', TRUE)
ON CONFLICT (id) DO NOTHING;

-- 2. Create policies for the 'notes-pdfs' bucket.
CREATE POLICY "Allow service_role to upload files"
ON storage.objects FOR INSERT TO service_role WITH CHECK (bucket_id = 'notes-pdfs');

CREATE POLICY "Allow service_role to update files"
ON storage.objects FOR UPDATE TO service_role USING (bucket_id = 'notes-pdfs');

CREATE POLICY "Allow service_role to delete files"
ON storage.objects FOR DELETE TO service_role USING (bucket_id = 'notes-pdfs');

CREATE POLICY "Public read access for files"
ON storage.objects FOR SELECT TO anon USING (bucket_id = 'notes-pdfs');
```

## 3. Get Project Credentials

You'll need your Supabase Project URL, the `anon` (public) key, and the `service_role` key.

1.  Go to your project's **Settings**.
2.  Click on the **API** tab.
3.  Under **Project API Keys**, you will find your `anon` key (labeled as `public`) and your `service_role` key.
4.  You will also find your Project **URL** there.

Create a `.env.local` file in the root of your project and add these credentials. **Keep your service_role key secret!**

```
NEXT_PUBLIC_SUPABASE_URL=YOUR_PROJECT_URL
NEXT_PUBLIC_SUPABASE_ANON_KEY=YOUR_ANON_KEY
SUPABASE_SERVICE_ROLE_KEY=YOUR_SERVICE_ROLE_KEY
```

## 4. (Optional) Add Example Data

To add some example notes to your database, run the following SQL in the **SQL Editor**:

```sql
-- Insert the new list of subjects provided by the user.
INSERT INTO public.subjects (name) VALUES
('বাংলা ১ম পত্র'),
('বাংলা ২য় পত্র'),
('English 1st Paper'),
('English 2nd Paper'),
('তথ্য ও যোগাযোগ প্রযুক্তি'),
('পৌরনীতি ও সুশাসন ১ম পত্র'),
('পৌরনীতি ও সুশাসন ২য় পত্র'),
('সমাজকর্ম ১ম পত্র'),
('সমাজকর্ম ২য় পত্র'),
('ইসলামের ইতিহাস ও সংস্কৃতি ১ম পত্র'),
('ইসলামের ইতিহাস ও সংস্কৃতি ২য় পত্র'),
('ভূগোল ১ম পত্র'),
('ভূগোল ২য় পত্র')
ON CONFLICT (name) DO NOTHING;
```

## 5. (Optional) Non-Destructive Schema Update for Multiple Images

If you already have data in your `subjects` and `chapters` tables and only want to update your `notes` table to support multiple images without losing data, run the following script instead of the full schema in step 1.

**This is the recommended safe method if you have existing data.**

```sql
-- Step 1: Create the new 'note_images' table to store multiple images per note.
-- This will be dropped and recreated if it already exists to ensure a clean setup.
DROP TABLE IF EXISTS public.note_images;
CREATE TABLE public.note_images (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    note_id BIGINT NOT NULL REFERENCES public.notes(id) ON DELETE CASCADE,
    image_url TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);
COMMENT ON TABLE public.note_images IS 'Stores image URLs for each note.';

-- Step 2: Remove the old 'pdf_url' column from the 'notes' table.
-- This command will only run if the column exists, preventing errors.
ALTER TABLE public.notes
DROP COLUMN IF EXISTS pdf_url;

-- Step 3: Ensure 'chapter_id' is optional in the 'notes' table.
ALTER TABLE public.notes
ALTER COLUMN chapter_id DROP NOT NULL;


-- Step 4: Create security policies for the new 'note_images' table.
-- These are recreated to ensure they are up-to-date.
DROP POLICY IF EXISTS "Public read access for note images" ON public.note_images;
CREATE POLICY "Public read access for note images"
ON public.note_images FOR SELECT TO anon USING (
  (SELECT is_published FROM public.notes WHERE id = note_id)
);

DROP POLICY IF EXISTS "Full access for service role on note_images" ON public.note_images;
CREATE POLICY "Full access for service role on note_images"
ON public.note_images FOR ALL TO service_role USING (true);

-- Step 5: Enable Row Level Security on the new table
ALTER TABLE public.note_images ENABLE ROW LEVEL SECURITY;
```
