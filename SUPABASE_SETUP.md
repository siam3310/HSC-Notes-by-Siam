# Supabase Backend Setup for HSC Hand Notes

Follow these steps to set up your Supabase project. You can run all of this SQL code at once in the Supabase SQL Editor.

**Important:** This schema documentation outlines the final structure. For migrating existing data, please use the non-destructive scripts provided in the later sections.

## 1. Full SQL Schema (For new projects)

If you are starting a new project, you can go to the **SQL Editor** in your Supabase project dashboard and run the following SQL command.

```sql
-- Drop old tables if they exist to apply the new schema.
-- WARNING: This will delete all existing data in these tables.
DROP TABLE IF EXISTS public.note_embeds;
DROP TABLE IF EXISTS public.note_images;
DROP TABLE IF EXISTS public.note_pdfs;
DROP TABLE IF EXISTS public.notes;
DROP TABLE IF EXISTS public.chapters;
DROP TABLE IF EXISTS public.subjects;

-- 1. Create the 'subjects' table to store subject names.
CREATE TABLE public.subjects (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name TEXT NOT NULL UNIQUE,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);
COMMENT ON TABLE public.subjects IS 'Stores all the subjects.';

-- 2. Create the 'chapters' table to store chapter names, linked to subjects.
CREATE TABLE public.chapters (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  subject_id BIGINT NOT NULL REFERENCES public.subjects(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  UNIQUE(subject_id, name) -- Ensures chapter names are unique within a subject
);
COMMENT ON TABLE public.chapters IS 'Stores chapters for each subject.';

-- 3. Create the 'notes' table without pdf_url.
CREATE TABLE public.notes (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  subject_id BIGINT NOT NULL REFERENCES public.subjects(id) ON DELETE RESTRICT,
  chapter_id BIGINT REFERENCES public.chapters(id) ON DELETE RESTRICT,
  topic_title TEXT NOT NULL,
  content TEXT,
  display_order INT NOT NULL DEFAULT 0,
  is_published BOOLEAN DEFAULT TRUE NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);
COMMENT ON TABLE public.notes IS 'Stores all the handwritten study notes.';
COMMENT ON COLUMN public.notes.display_order IS 'Controls the display order of notes. Lower numbers appear first.';


-- 4. Create the 'note_images' table for the one-to-many relationship with notes.
CREATE TABLE public.note_images (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    note_id BIGINT NOT NULL REFERENCES public.notes(id) ON DELETE CASCADE,
    image_url TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);
COMMENT ON TABLE public.note_images IS 'Stores image URLs for each note.';

-- 5. Create the 'note_pdfs' table for the one-to-many relationship with notes.
CREATE TABLE public.note_pdfs (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    note_id BIGINT NOT NULL REFERENCES public.notes(id) ON DELETE CASCADE,
    pdf_url TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);
COMMENT ON TABLE public.note_pdfs IS 'Stores PDF URLs for each note.';

-- 5.5. Create the 'note_embeds' table for storing embeddable URLs (e.g. Google Drive).
CREATE TABLE public.note_embeds (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    note_id BIGINT NOT NULL REFERENCES public.notes(id) ON DELETE CASCADE,
    embed_url TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);
COMMENT ON TABLE public.note_embeds IS 'Stores embeddable URLs for each note.';

-- 6. Enable Row Level Security on all tables.
ALTER TABLE public.subjects ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.chapters ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.notes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.note_images ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.note_pdfs ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.note_embeds ENABLE ROW LEVEL SECURITY;

-- 7. Create policies for 'subjects' table.
CREATE POLICY "Public read access for subjects" ON public.subjects FOR SELECT TO anon, authenticated USING (true);
CREATE POLICY "Full access for service role on subjects" ON public.subjects FOR ALL TO service_role USING (true);

-- 8. Create policies for 'chapters' table.
CREATE POLICY "Public read access for chapters" ON public.chapters FOR SELECT TO anon, authenticated USING (true);
CREATE POLICY "Full access for service role on chapters" ON public.chapters FOR ALL TO service_role USING (true);

-- 9. Create policies for 'notes' table.
CREATE POLICY "Public read-only access to published notes" ON public.notes FOR SELECT TO anon, authenticated USING (is_published = TRUE);
CREATE POLICY "Full access for service role on notes" ON public.notes FOR ALL TO service_role USING (true);

-- 10. Create policies for 'note_images' table.
CREATE POLICY "Public read access for note images" ON public.note_images FOR SELECT TO anon, authenticated USING ((SELECT is_published FROM public.notes WHERE id = note_id));
CREATE POLICY "Full access for service role on note_images" ON public.note_images FOR ALL TO service_role USING (true);

-- 11. Create policies for 'note_pdfs' table.
CREATE POLICY "Public read access for note pdfs" ON public.note_pdfs FOR SELECT TO anon, authenticated USING ((SELECT is_published FROM public.notes WHERE id = note_id));
CREATE POLICY "Full access for service role on note_pdfs" ON public.note_pdfs FOR ALL TO service_role USING (true);

-- 12. Create policies for 'note_embeds' table.
CREATE POLICY "Public read access for note embeds" ON public.note_embeds FOR SELECT TO anon, authenticated USING ((SELECT is_published FROM public.notes WHERE id = note_id));
CREATE POLICY "Full access for service role on note_embeds" ON public.note_embeds FOR ALL TO service_role USING (true);
```

## 2. Setup Storage for PDF/Image Uploads

This part remains the same. If you've already done this, you don't need to do it again.

```sql
-- 1. Create a storage bucket named 'notes-pdfs' to hold the uploaded files.
-- Make it public so that anyone with the URL can view the file.
INSERT INTO storage.buckets (id, name, public)
VALUES ('notes-pdfs', 'notes-pdfs', TRUE)
ON CONFLICT (id) DO NOTHING;

-- 2. Create policies for the 'notes-pdfs' bucket.
-- This policy allows the service_role to perform any action.
CREATE POLICY "Allow service_role full access"
ON storage.objects FOR ALL
TO service_role
USING (bucket_id = 'notes-pdfs');

-- This policy allows any user (public/anon) to upload files.
-- This is needed for the admin panel client-side uploads.
CREATE POLICY "Allow public uploads"
ON storage.objects FOR INSERT
TO anon, authenticated
WITH CHECK (bucket_id = 'notes-pdfs');

-- This policy allows any authenticated user to update their own files.
-- (This might be useful later, but is good practice to have)
CREATE POLICY "Allow authenticated users to update own files"
ON storage.objects FOR UPDATE
TO authenticated
USING (bucket_id = 'notes-pdfs' AND auth.uid() = (metadata->>'owner')::uuid);


CREATE POLICY "Public read access for files"
ON storage.objects FOR SELECT TO anon, authenticated USING (bucket_id = 'notes-pdfs');
```

## 3. Get Project Credentials

You'll need your Supabase Project URL, the `anon` (public) key, and the `service_role` key.

1.  Go to your project's **Settings**.
2.  Click on the **API** tab.
3.  Under **Project API Keys**, you will find your `anon` key (labeled as `public`) and your `service_role` key.
4.  You will also find your Project **URL** there.

Create a `.env` file in the root of your project and add these credentials. **Keep your service_role key secret!** For production, you should set these as environment variables in your hosting provider's dashboard.

```
NEXT_PUBLIC_SUPABASE_URL=YOUR_PROJECT_URL
NEXT_PUBLIC_SUPABASE_ANON_KEY=YOUR_ANON_KEY
SUPABASE_SERVICE_ROLE_KEY=YOUR_SERVICE_ROLE_KEY
```

## 4. (Optional) Add Example Data

To add some example notes to your database, run the following SQL in the **SQL Editor**:

```sql
-- Insert the new list of subjects provided by the user.
INSERT INTO public.subjects (name) VALUES
('বাংলা ১ম পত্র'),
('বাংলা ২য় পত্র'),
('English 1st Paper'),
('English 2nd Paper'),
('তথ্য ও যোগাযোগ প্রযুক্তি'),
('পৌরনীতি ও সুশাসন ১ম পত্র'),
('পৌরনীতি ও সুশাসন ২য় পত্র'),
('সমাজকর্ম ১ম পত্র'),
('সমাজকর্ম ২য় পত্র'),
('ইসলামের ইতিহাস ও সংস্কৃতি ১ম পত্র'),
('ইসলামের ইতিহাস ও সংস্কৃতি ২য় পত্র'),
('ভূগোল ১ম পত্র'),
('ভূগোল ২য় পত্র')
ON CONFLICT (name) DO NOTHING;
```

## 5. Non-Destructive Schema Update 

If you have existing data and want to update your schema, **run the following safe scripts**.

### 5.1 Add PDF and Image Tables (if you haven't already)

If you are on an older schema that only has a `pdf_url` column on the `notes` table, run this first.

```sql
-- Step 1: Create the new 'note_pdfs' table if it doesn't exist.
CREATE TABLE IF NOT EXISTS public.note_pdfs (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    note_id BIGINT NOT NULL REFERENCES public.notes(id) ON DELETE CASCADE,
    pdf_url TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);
COMMENT ON TABLE public.note_pdfs IS 'Stores PDF URLs for each note.';

-- Step 2: Create a temporary function to migrate existing pdf_url data.
CREATE OR REPLACE FUNCTION migrate_pdfs()
RETURNS void AS $$
DECLARE
    note_record RECORD;
BEGIN
    -- Check if the pdf_url column exists before trying to read from it
    IF EXISTS (
        SELECT 1
        FROM information_schema.columns
        WHERE table_name = 'notes' AND column_name = 'pdf_url'
    ) THEN
        FOR note_record IN SELECT id, pdf_url FROM public.notes WHERE pdf_url IS NOT NULL LOOP
            INSERT INTO public.note_pdfs (note_id, pdf_url)
            VALUES (note_record.id, note_record.pdf_url);
        END LOOP;
    END IF;
END;
$$ LANGUAGE plpgsql;

-- Step 3: Execute the migration.
SELECT migrate_pdfs();

-- Step 4: Drop the temporary function.
DROP FUNCTION migrate_pdfs();

-- Step 5: Drop the old pdf_url column from the notes table.
ALTER TABLE public.notes
DROP COLUMN IF EXISTS pdf_url;

-- Step 6: Create/Recreate security policies for the 'note_pdfs' table for safety.
DROP POLICY IF EXISTS "Public read access for note pdfs" ON public.note_pdfs;
CREATE POLICY "Public read access for note pdfs"
ON public.note_pdfs FOR SELECT TO anon, authenticated USING (
  (SELECT is_published FROM public.notes WHERE id = note_id)
);

DROP POLICY IF EXISTS "Full access for service role on note_pdfs" ON public.note_pdfs;
CREATE POLICY "Full access for service role on note_pdfs"
ON public.note_pdfs FOR ALL TO service_role USING (true);

-- Step 7: Enable Row Level Security on the new table if it's not already enabled.
ALTER TABLE public.note_pdfs ENABLE ROW LEVEL SECURITY;
```

### 5.2 Add `display_order` column

Run this script to add the ordering functionality.

```sql
-- Add display_order column to notes table if it doesn't exist
ALTER TABLE public.notes
ADD COLUMN IF NOT EXISTS display_order INT NOT NULL DEFAULT 0;

COMMENT ON COLUMN public.notes.display_order IS 'Controls the display order of notes. Lower numbers appear first.';
```

### 5.3 Add `note_embeds` table

Run this to add the new table for embeddable links.

```sql
-- Create the 'note_embeds' table for storing embeddable URLs.
CREATE TABLE IF NOT EXISTS public.note_embeds (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    note_id BIGINT NOT NULL REFERENCES public.notes(id) ON DELETE CASCADE,
    embed_url TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);
COMMENT ON TABLE public.note_embeds IS 'Stores embeddable URLs for each note.';

-- Enable Row Level Security
ALTER TABLE public.note_embeds ENABLE ROW LEVEL SECURITY;

-- Create policies for 'note_embeds' table.
CREATE POLICY "Public read access for note embeds" ON public.note_embeds FOR SELECT TO anon, authenticated USING ((SELECT is_published FROM public.notes WHERE id = note_id));
CREATE POLICY "Full access for service role on note_embeds" ON public.note_embeds FOR ALL TO service_role USING (true);

```
